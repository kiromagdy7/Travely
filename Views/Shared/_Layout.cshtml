<!-- Existing layout content above retained -->

<script src="~/js/main.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const notifIcon = document.getElementById("notifIcon");
        const notifPopup = document.getElementById("notifPopup");
        const notifList = document.getElementById("notifList");
        const notifBadge = document.getElementById("notifBadge");
        const notifContainer = document.querySelector(".notif-container");
        const userRole = document.querySelector('meta[name="user-role"]')?.content || "User";
        const userId = document.querySelector('meta[name="user-id"]')?.content || 0;

        async function refreshBadge() {
            try {
                const res = await fetch(`/Notifications/Count?role=${userRole}&userId=${userId}`);
                if (res.ok) {
                    const count = await res.json();
                    if (count > 0) {
                        notifBadge.textContent = count;
                        notifBadge.hidden = false;
                    } else {
                        notifBadge.hidden = true;
                    }
                }
            } catch { /* ignore */ }
        }

        async function loadNotifications() {
            try {
                const res = await fetch(`/Notifications/List?role=${userRole}&userId=${userId}`);
                const html = await res.text();
                notifList.innerHTML = html;
            } catch {
                notifList.innerHTML = "<div class='p-3 text-center text-muted'>Error loading notifications</div>";
            }
        }

        // Delegated events for newly loaded items
        notifList.addEventListener("click", async (e) => {
            const markBtn = e.target.closest(".mark-read-inline");
            const deleteBtn = e.target.closest(".delete-inline");
            const item = e.target.closest(".notif-item");

            // Clicking on the body (not buttons) marks as read if unread
            if (item && !markBtn && !deleteBtn) {
                const id = item.getAttribute("data-id");
                if (item.classList.contains("unread")) {
                    try {
                        const res = await fetch(`/Notifications/MarkAsRead?id=${id}`, { method: "POST" });
                        if (res.ok) {
                            item.classList.remove("unread");
                            const btn = item.querySelector(".mark-read-inline");
                            if (btn) btn.remove();
                            refreshBadge();
                        }
                    } catch { }
                }
            }

            if (markBtn) {
                const id = markBtn.getAttribute("data-id");
                try {
                    const res = await fetch(`/Notifications/MarkAsRead?id=${id}`, { method: "POST" });
                    if (res.ok) {
                        const parent = markBtn.closest(".notif-item");
                        if (parent) parent.classList.remove("unread");
                        markBtn.remove();
                        refreshBadge();
                    }
                } catch { }
            }

            if (deleteBtn) {
                if (!confirm("Delete this notification?")) return;
                const id = deleteBtn.getAttribute("data-id");
                try {
                    const res = await fetch(`/Notifications/Delete?id=${id}`, { method: "POST" });
                    if (res.ok) {
                        const itemRow = deleteBtn.closest(".notif-item");
                        if (itemRow) itemRow.remove();
                        if (!notifList.querySelector(".notif-item")) {
                            notifList.innerHTML = "<div class='p-3 text-center text-muted'>There are no notifications</div>";
                        }
                        refreshBadge();
                    }
                } catch { }
            }
        });

        notifIcon.addEventListener("click", async () => {
            const isVisible = notifPopup.classList.toggle("visible");
            if (isVisible) {
                await loadNotifications();
                await refreshBadge();
            }
        });

        document.addEventListener("click", e => {
            if (!notifContainer.contains(e.target)) {
                notifPopup.classList.remove("visible");
            }
        });

        // Periodic badge update
        setInterval(refreshBadge, 20000);

        // Initial load badge
        refreshBadge();
    });
</script>
<!-- Existing layout closing tags -->